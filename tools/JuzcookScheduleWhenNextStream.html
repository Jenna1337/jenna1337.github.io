<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8" />
<meta name="description" content="Find out when juzcook is streaming next" />
<meta name="keywords" content="juzcook" />
<meta name="author" content="Jenna Sloan" />
<title>juzcook, when's the next stream?</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="light dark" />
<style>
:root {
	--outline-size: 0.4ex;
	--border-size: 1px;
}
body {
	font-family: "Arial", "Verdana", "Calibri", sans-serif;
}
#config {
	position: sticky;
	top: 0;
	background-color: #FFFE;
	background-color: Canvas;
	background-color: color-mix(in srgb, Canvas, transparent 5%);
	margin-block-end: 1lh;
}
#table {
	border-collapse: collapse;
	thead > *{
		background-color: rgb(201, 218, 248);
		background-color: color-mix(in srgb, Canvas, #05D 21%);
	}
	margin-block-start: 1lh;
}
.scheduleDay > *{
	display: table-cell;
	border: var(--border-size) solid black;
	padding-inline: 0.5ex;
	line-height: 1.2;
}
[data-isstream]{/*yellow*/
	background-color: rgb(255, 242, 204);
	background-color: color(srgb 1 0.94902 0.8);
	background-color: color-mix(in srgb, Canvas, #FB0 20%);
	time {
		font-weight: bold;
	}
}
[data-isstream="true"]{/*green*/
	background-color: rgb(217, 234, 211);
	background-color: color-mix(in srgb, Canvas, #492 20%);
	time {
		font-weight: normal;
	}
}
[data-isstream="false"]{/*red*/
	background-color: color-mix(in srgb, Canvas, #C40404 25%);
}
/* Select all elements between [data-last="true"] and [data-next="true"] */
[data-last="true"] ~ *:has(~[data-next="true"]) {
	outline: var(--outline-size) solid #8889;
	outline-offset: calc(var(--border-size) - var(--outline-size));
	/*--outline-size-a: calc(var(--outline-size) + var(--border-size));
	border-left: var(--outline-size-a) solid #8889;
	border-right: var(--outline-size-a) solid #8889;*/
}
[data-next="true"], #nextstream>tr {
	outline: var(--outline-size) solid #0FF9;
}
[data-last="true"], #laststream>tr {
	outline: var(--outline-size) solid #F889;
}
.links {
	img {
		height: 1lh;
		width: 1lh;
		vertical-align: middle;
	}
}
</style>
<script>
function formatAsDurationString(ms){
	var TotalSeconds = Math.round(Math.abs(ms)/1000);
	var seconds = TotalSeconds%60;
	var TotalMinutes = Math.floor(TotalSeconds/60);
	var minutes = TotalMinutes%60;
	var TotalHours = Math.floor(TotalMinutes/60);
	var hours = TotalHours%24;
	var TotalDays = Math.floor(TotalHours/24);
	var days = TotalDays;
	return ({
		'long': `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`,
		'medium': `${days} d, ${hours} h, ${minutes} m, ${seconds} s`,
		'short': `${days}:${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`
	});
}
function findNextStreamDate(){
	document.querySelectorAll("[data-next]").forEach(a=>{
		a.dataset.next = null;
		delete a.dataset.next;
	});
	document.querySelectorAll("[data-last]").forEach(a=>{
		a.dataset.last = null;
		delete a.dataset.last;
	});
	const laststreamElem = document.getElementById("laststream");
	const nextstreamElem = document.getElementById("nextstream");
	const timesincestreamElem = document.getElementById("timesincestream");
	const timeuntilstreamElem = document.getElementById("timeuntilstream");
	const now = Date.now();
	const elemTimeMap = [...document.querySelectorAll("table .scheduleDay[data-isstream=\"true\"] time")].map(elem => [elem,new Date(elem.getAttribute('datetime'))]);
	var q, r, d;
	var pastDates = elemTimeMap.filter(date => date[1] < now);
	if(pastDates.length < 1){
		//no stream :(
		laststreamElem.innerHTML = '';
		laststreamElem.textContent = "Upcoming stream not found";
		timesincestreamElem.textContent = "";
	} else {
		pastDates.sort((a, b) => a[1].getTime() - b[1].getTime());
		(r=(q=pastDates.at(-1))[0].closest("tr")).dataset.last = "true";
		if(laststreamElem.textContent != r.textContent){
			laststreamElem.innerHTML = '';
			laststreamElem.append(r.cloneNode(true));
		}
		d = formatAsDurationString(q[1] - now);
		timesincestreamElem.textContent = d.short + ' ago';
		timesincestreamElem.title = d.long + ' ago';
		timesincestreamElem.setAttribute("aria-label", d.long + ' ago');
	}
	
	var upcomingDates = elemTimeMap.filter(date => date[1] > now);
	if(upcomingDates.length < 1){
		//no stream :(
		nextstreamElem.innerHTML = '';
		nextstreamElem.textContent = "Upcoming stream not found";
		timeuntilstreamElem.textContent = "";
	} else {
		upcomingDates.sort((a, b) => a[1].getTime() - b[1].getTime());
		(r=(q=upcomingDates[0])[0].closest("tr")).dataset.next = "true";
		if(nextstreamElem.textContent != r.textContent){
			nextstreamElem.innerHTML = '';
			nextstreamElem.append(r.cloneNode(true));
		}
		d = formatAsDurationString(q[1] - now);
		timeuntilstreamElem.textContent = d.short + ' from now';
		timeuntilstreamElem.title = d.long + ' from now';
		timeuntilstreamElem.setAttribute("aria-label", d.long + ' from now');
	}
	
	var currentTimeElem = document.getElementById("currentTime");
	currentTimeElem.setAttribute("datetime", new Date().toISOString());
	currentTimeElem.dataset.done_init = "0";
	formatTimeLabel(currentTimeElem, new Date(currentTimeElem.getAttribute('datetime')));
}
console.log(window.setInterval(findNextStreamDate, 1000));
const aest_offset_h = -10;
function onload(){
	var rawelem = document.getElementById("raw");
	const url = "https://docs.google.com/spreadsheets/d/10AScqC2S8UPmvSPJ6d7SDa4w_x7VTplUqp4xGkq1lPg/export?format=tsv";
	fetch(url)
	.then(r=>{
		r.text().then(t=>{
			window.dat = t.split("\n").map(a=>a.split("\t"));
			var lastdate = null;
			var year = new Date().getFullYear();
			var timeparsesuccess = false;
			function parseDate(str){
				str = str.trim().toLowerCase();
				const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"]
				var month = Number(months.findIndex(m=>str.startsWith(m)));
				var day = Number(str.match(/\d+/gm));
				if(lastdate != null){
					year = lastdate.getFullYear();
				}
				var date = new Date(year, month, day);
				var dff= date - Date.now();
				const msInAYear = 31556952000;
				if(dff > (msInAYear/2)){
					date.setYear(year - 1);
				}
				return date;
			}
			function dateFunc(row, doinc){
				var val = row.slice(1,3).join('');
				var retval = lastdate;
				if(val.trim().length > 0){
					retval = lastdate = parseDate(val);
				}else{
					if(lastdate !== null && doinc)
					{
						lastdate = new Date(lastdate);
						lastdate.setDate(lastdate.getDate() + 1);
						retval = lastdate;
					}
				}
				return retval;
			}
			function starttimeFunc(row){
				dateFunc(row, true)
				var val = row[4].trim();
				var retval = lastdate;
				var match = val.match(/(\d+):(\d+)\s*(A|P)M?/i);
				timeparsesuccess = Boolean(match);
				if(val==="TBA"){
					timeparsesuccess = undefined;
				}
				if(match){
					var h = Number(match[1]);
					var m = Number(match[2]);
					var ispm = Boolean(match[3]?.match(/P/i));
					if(ispm)
						h += 12;
					lastdate.setUTCHours(h + aest_offset_h);
					lastdate.setUTCMinutes(m);
				}
				return retval;
			}
			const startIndex = dat.findIndex(a=>a[0].length>1 || a[1].length>1);
			let sample = dat.slice(startIndex, 100);
			const endIndex = sample.findLastIndex(a=>a[3].length>0);
			sample = sample.slice(0, endIndex + 1);
			const tbody = document.getElementById("tbody");
			sample.map(row=>({
				'startdatetime': starttimeFunc(row),
				'startdatetimetextoverride': timeparsesuccess ? null : row[4],
				'game': row.slice(5,9).filter(a=>a.length>0).join(' '),
				'isstream': timeparsesuccess
			}))
			.forEach(item=>{
				var rowElem = document.createElement('tr');
				rowElem.className = "scheduleDay";
				rowElem.dataset['isstream'] = item.isstream;
				
				var dtElem = document.createElement('time');
				dtElem.setAttribute('datetime', item.startdatetime.toISOString());
				dtElem.textContent = item.startdatetime;
				var dtElemTd = document.createElement('td');
				dtElemTd.appendChild(dtElem);
				rowElem.appendChild(dtElemTd);
				
				var dtElem = document.createElement('time');
				dtElem.setAttribute('datetime', item.startdatetime.toISOString());
				dtElem.textContent = item.startdatetimetextoverride ?? item.startdatetime;
				var dtElemTd = document.createElement('td');
				dtElemTd.appendChild(dtElem);
				rowElem.appendChild(dtElemTd);
				
				var gameElem = document.createElement('div');
				gameElem.textContent = item.game;
				var gameElemTd = document.createElement('td');
				gameElemTd.appendChild(gameElem);
				rowElem.appendChild(gameElemTd);
				
				
				tbody.appendChild(rowElem);
			});
			document.getElementById('timeformatselector').onchange();
		})
	})
	;
}
</script>
</head>
<body onload="onload()">
<h1>juzcook next stream checker</h1>
<noscript>This page requires JavaScript</noscript>
<div id="config" aria-label="Settings"><label for="timeformatselector">Display times in the format: </label>
<select id="timeformatselector" onchange="timeformatselectorchanged()" title="Times will be displayed in the selected format">
<option value="aest_time">AEST time (UTC+10)</option>
<option value="Locale_time_string" selected="">Locale time string</option>
<option value="ISO_8601_-_UTC">ISO 8601 - UTC</option>
<option value="ISO_8601_-_local_time_zone">ISO 8601 - your local time zone</option>
<option value="ISO_8601_-_AEST">ISO 8601 - AEST</option>
<option value="local_time">Your local time</option>
</select></div>
<p class="links" aria-label="Links">
<a href="https://twitch.tv/juzcook"><img src="https://twitch.tv/favicon.ico" aria-hidden="true" /> Watch juzcook on Twitch</a><br />
<a href="https://youtube.com/@juzcook/live"><img src="https://youtube.com/favicon.ico" aria-hidden="true" /> Watch juzcook on YouTube</a><br />
<a href="https://docs.google.com/spreadsheets/d/10AScqC2S8UPmvSPJ6d7SDa4w_x7VTplUqp4xGkq1lPg/edit?usp=sharing"><img src="https://docs.google.com/favicon.ico" aria-hidden="true" /> View the official juzcook Schedule on Google Sheets</a>
</p>
<div aria-label="Current time"><span>Current time: <time id="currentTime" role="timer" aria-live="off"></time></span></div>
<div aria-label="Previous stream"><span>Last stream: </span><span id="timesincestream" role="timer" aria-live="off"></span>
<div id="laststream"></div>
</div>
<div aria-label="Next stream"><span>Next stream: </span><span id="timeuntilstream" role="timer" aria-live="off"></span>
<div id="nextstream"></div>
</div>
<table id="table">
<thead><tr><th scope="col">Date</th><th scope="col">Start Time</th><th scope="col">Game</th></tr></thead>
<tbody id="tbody"></tbody>
</table>
<script>
var timeformat = window.localStorage?.timeformat ?? "Locale_time_string";

{
	const init = ()=>{
		//set selected item on timeformatselector to whatever matched window.localStorage.timeformat
		const timeformatselector = document.getElementById("timeformatselector");
		timeformatselector.value = window.localStorage?.timeformat ?? "Locale_time_string";
		timeformatselector.onchange();
	};
	document.addEventListener('load',init);
	window.addEventListener('load',init);
}

function formatTimeLabel(timelabel, dt, dateonly = false){
	const options = {
	  weekday: "long",
	  year: "numeric",
	  month: "long",
	  day: "numeric",
	};
	var ofst = dt.getTimezoneOffset();
	var j_ofst = aest_offset_h * 60;
	if(timelabel.dataset['done_init'] != "1"){
		timelabel.dataset['done_init'] = "1";
		var AESTAdjustedTime = new Date(dt);
		AESTAdjustedTime.setHours(AESTAdjustedTime.getHours() - aest_offset_h + ofst/60);
		timelabel.dataset['aest_time'] = AESTAdjustedTime.toLocaleString("en-AU", dateonly ? options : ({}));
		timelabel.dataset['local_time'] = dateonly ? dt.toDateString() : dt.toString();
		timelabel.dataset['Locale_time_string'] = dt.toLocaleString(navigator.language, dateonly ? options : ({}));
		timelabel.dataset['ISO_8601_-_UTC'] = dt.toISOString().replace(/T.*?$/gm, dateonly ? '' : '$&');
		timelabel.dataset['ISO_8601_-_local_time_zone'] = (new Date(dt - ofst * 60 * 1000)).toISOString().replace('Z',(-Math.sign(ofst) < 0 ? '-' : '+')+String(Math.abs(ofst/60*100)).padStart(4,'0').split(/(?=..$)/).join(':')).replace(/T.*?(?=[Z\+\-])/gm, dateonly ? 'T' : '$&');
		timelabel.dataset['ISO_8601_-_AEST'] = (new Date(dt - j_ofst * 60 * 1000)).toISOString().replace('Z',(-Math.sign(j_ofst) < 0 ? '-' : '+')+String(Math.abs(j_ofst/60*100)).padStart(4,'0').split(/(?=..$)/).join(':')).replace(/T.*?(?=[Z\+\-])/gm, dateonly ? 'T' : '$&');
	}
	timelabel.textContent = timelabel.dataset[timeformat];
}
function timeformatselectorchanged(){
	timeformat = document.getElementById('timeformatselector').value;
	window.localStorage.timeformat = timeformat;
	
	document.querySelectorAll(".scheduleDay[data-isstream=\"true\"] time,.scheduleDay>*:first-of-type time").forEach(elem=>{
		formatTimeLabel(elem, new Date(elem.getAttribute('datetime')), elem.closest('tr>*')===elem.closest('tr').firstChild)
	})
}

</script>
</body>
</html>
